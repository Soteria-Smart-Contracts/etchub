<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Page</title>
</head>
<body>
    <h1>Admin Console</h1>

    <div style="margin: 2em 0;">
        <button id="createTestArticle" class="btn-primary px-6 py-3 rounded-lg font-semibold">
            Create Test Article
        </button>
    </div>

    <hr style="margin: 2em 0;">

    <h2>Submission Queue</h2>
    <div id="submissionQueue">
        <p>Loading submissions...</p>
    </div>

    <hr style="margin: 2em 0;">

    <h2>Existing Articles</h2>
    <div id="articlesList">
        <p>Loading existing articles...</p>
    </div>

    <div id="previewPane" style="display:none; position: fixed; top: 10%; left: 20%; width: 60%; height: 70%; background: #333; color: #fff; border: 1px solid #ccc; padding: 20px; box-shadow: 0 0 10px rgba(0,0,0,0.5); overflow-y: auto;">
        <h3 id="previewTitle"></h3>
        <p><strong>By:</strong> <span id="previewAuthor"></span></p>
        <hr>
        <div id="previewDescription" class="mb-4 text-gray-200"></div>
        <hr>
        <div id="previewContent"></div>
        <button onclick="closePreview()" style="margin-top: 20px;">Close</button>
    </div>

    <script>
        let submissionsData = [];

        const fetchAndDisplaySubmissions = async () => {
            try {
                const response = await fetch('/api/submissions');
                if (!response.ok) {
                    const queueDiv = document.getElementById('submissionQueue');
                    const errorText = await response.text();
                    queueDiv.innerHTML = `<p style="color: red;">Error loading submissions: ${errorText}</p>`;
                    return;
                }
                submissionsData = await response.json();
                const queueDiv = document.getElementById('submissionQueue');

                if (submissionsData.length === 0) {
                    queueDiv.innerHTML = '<p>No submissions yet.</p>';
                    return;
                }

                const table = `
                    <table border="1" style="width:100%; border-collapse: collapse;">
                        <thead>
                            <tr>
                                <th style="padding: 8px; text-align: left;">ID</th>
                                <th style="padding: 8px; text-align: left;">Title</th>
                                <th style="padding: 8px; text-align: left;">Author</th>
                                <th style="padding: 8px; text-align: left;">Status</th>
                                <th style="padding: 8px; text-align: left;">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${submissionsData.map(s => `
                                <tr>
                                    <td style="padding: 8px;">${s.id}</td>
                                    <td style="padding: 8px;">${s.title}</td>
                                    <td style="padding: 8px;">${s.xUsername}</td>
                                    <td style="padding: 8px;">${s.approved ? 'Approved' : 'Pending'}</td>
                                    <td style="padding: 8px;">
                                        <button onmouseover="previewSubmission(${s.id})" onmouseout="hidePreview()">Preview</button>
                                        ${!s.approved ? `<button onclick="approveSubmission(${s.id})">Approve</button>` : ''}
                                        <button onclick="deleteSubmission(${s.id})">Delete</button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
                queueDiv.innerHTML = table;
            } catch (error) {
                console.error('Failed to fetch submissions:', error);
                document.getElementById('submissionQueue').innerHTML = '<p style="color: red;">Failed to load submissions. Check the console for details.</p>';
            }
        };

        const previewSubmission = (id) => {
            const submission = submissionsData.find(s => s.id == id);
            if (!submission) return;

            document.getElementById('previewTitle').innerText = submission.title;
            document.getElementById('previewAuthor').innerText = submission.xUsername;
            document.getElementById('previewDescription').innerText = submission.description || '';
            document.getElementById('previewContent').innerText = submission.content;
            document.getElementById('previewPane').style.display = 'block';
        };

        const hidePreview = () => {
            document.getElementById('previewPane').style.display = 'none';
        };

        const closePreview = () => {
            document.getElementById('previewPane').style.display = 'none';
        };

        const approveSubmission = async (id) => {
            const response = await fetch(`/api/submissions/approve/${id}`, { method: 'PUT' });
            const result = await response.text();
            alert(result);
            fetchAndDisplaySubmissions();
            fetchAndDisplayArticles(); // Refresh existing articles section
        };

        const deleteSubmission = async (id) => {
            if (confirm('Are you sure you want to delete this submission?')) {
                const response = await fetch(`/api/submissions/delete/${id}`, { method: 'DELETE' });
                const result = await response.text();
                alert(result);
                fetchAndDisplaySubmissions();
            }
        };
        const fetchAndDisplayArticles = async () => {
            try {
                const response = await fetch('/api/articles');
                if (!response.ok) {
                    const articlesDiv = document.getElementById('articlesList');
                    const errorText = await response.text();
                    articlesDiv.innerHTML = `<p style="color: red;">Error loading articles: ${errorText}</p>`;
                    return;
                }
                const articles = await response.json();
                const articlesDiv = document.getElementById('articlesList');

                if (articles.length === 0) {
                    articlesDiv.innerHTML = '<p>No existing articles yet.</p>';
                    return;
                }

                const table = `
                    <table border="1" style="width:100%; border-collapse: collapse;">
                        <thead>
                            <tr>
                                <th style="padding: 8px; text-align: left;">Title</th>
                                <th style="padding: 8px; text-align: left;">URL</th>
                                <th style="padding: 8px; text-align: left;">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${articles.map(article => `
                                <tr>
                                    <td style="padding: 8px;">${article.title}</td>
                                    <td style="padding: 8px;"><a href="${article.url}" target="_blank">${article.url}</a></td>
                                    <td style="padding: 8px;">
                                        <button onclick="deleteArticle('${article.slug}')">Delete</button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
                articlesDiv.innerHTML = table;
            } catch (error) {
                console.error('Failed to fetch articles:', error);
                document.getElementById('articlesList').innerHTML = '<p style="color: red;">Failed to load articles. Check the console for details.</p>';
            }
        };

        const deleteArticle = async (slug) => {
            if (confirm(`Are you sure you want to delete the article "${slug}"? This action cannot be undone.`)) {
                try {
                    const response = await fetch(`/api/articles/${slug}`, {
                        method: 'DELETE'
                    });
                    const result = await response.text();
                    alert(result);
                    fetchAndDisplayArticles();
                } catch (error) {
                    console.error('Failed to delete article:', error);
                    alert('Failed to delete article. Please try again.');
                }
            }
        };

        document.addEventListener('DOMContentLoaded', () => {
            fetchAndDisplaySubmissions();
            fetchAndDisplayArticles();
            
            // Add event listener for create test article button
            document.getElementById('createTestArticle').addEventListener('click', async () => {
                const testArticle = {
                    title: "Test Article",
                    xUsername: "Test Author",
                    content: "Lorem ipsum dolor sit amet, consectetur adipiscing elit. Nullam in dui mauris. Vivamus hendrerit arcu sed erat molestie vehicula. Sed auctor neque eu tellus rhoncus ut eleifend nibh porttitor. Ut in nulla enim. Phasellus molestie magna non est bibendum non venenatis nisl tempor. Suspendisse dictum feugiat nisl ut dapibus. Mauris iaculis porttitor posuere. Praesent id metus massa, ut blandit odio. Proin quis tortor orci.\n\nEtiam at risus et justo dignissim congue. Donec congue lacinia dui, a porttitor lectus condimentum laoreet. Nunc eu ullamcorper orci. Quisque eget odio ac lectus vestibulum faucibus eget in metus. In pellentesque faucibus vestibulum. Nulla at nulla justo, eget luctus tortor. Nulla facilisi. Duis aliquam egestas hendrerit. Nam consectetur risus et diam luctus lobortis.\n\nAliquam erat volutpat. Nunc eleifend leo vitae magna. In id erat non orci commodo lobortis. Proin neque massa, cursus ut, ultrices ac, accumsan nec, leo. Vestibulum ante ipsum primis in faucibus orci luctus et ultrices posuere cubilia Curae; Donec pharetra, magna vestibulum aliquet ultrices, erat tortor sollicitudin mi, sit amet lobortis sapien sapien non mi. Integer ac neque. Duis bibendum. Morbi non quam nec dui luctus rutrum. Nulla tellus. In sagittis dui vel nisl. Duis ac nibh. Fusce lacus purus, aliquet at, feugiat non, pretium quis, lectus.\n\nSuspendisse potenti. In eleifend quam a odio. In hac habitasse platea dictumst. Maecenas ut massa quis augue luctus tincidunt. Nulla mollis molestie lorem. Quisque ut erat. Curabitur gravida nisi at nibh. In hac habitasse platea dictumst. Aliquam augue quam, sollicitudin vitae, consectetuer eget, rutrum at, lorem. Integer tincidunt ante vel ipsum. Praesent blandit lacinia erat. Vestibulum sed magna at nunc commodo placerat.\n\nPraesent blandit. Nam nulla. Integer pede justo, lacinia eget, tincidunt eget, tempus vel, pede. Morbi porttitor lorem id ligula. Suspendisse ornare consequat lectus. In est risus, auctor sed, tristique in, tempus sit amet, sem. Fusce consequat. Nulla nisl. Nunc nisl. Duis bibendum, felis sed interdum venenatis, turpis enim blandit mi, in porttitor pede justo eu massa. Donec dapibus. Duis at velit eu est congue elementum. In hac habitasse platea dictumst. Morbi vestibulum, velit id pretium iaculis, diam erat fermentum justo, nec condimentum neque sapien placerat ante. Nulla justo.\n\nAliquam quis turpis eget elit sodales scelerisque. Mauris sit amet eros. Suspendisse accumsan tortor quis turpis. Sed ante. Vivamus tortor. Duis mattis egestas metus. Aenean fermentum. Donec ut mauris eget massa tempor convallis. Nulla neque libero, convallis eget, eleifend luctus, ultricies eu, nibh. Quisque id justo sit amet sapien dignissim vestibulum.\n\nVestibulum ante ipsum primis in faucibus orci luctus et ultrices posuere cubilia Curae; Nulla dapibus dolor vel est. Donec odio justo, sollicitudin ut, suscipit a, feugiat et, eros. Vestibulum ac est lacinia nisi venenatis tristique. Fusce congue, diam id ornare imperdiet, sapien urna pretium nisl, ut volutpat sapien arcu sed augue. Aliquam erat volutpat. In congue. Etiam justo. Etiam pretium iaculis justo. In hac habitasse platea dictumst. Etiam faucibus cursus urna. Ut tellus.\n\nNulla ut erat id mauris vulputate elementum. Nullam varius. Nulla facilisi. Cras non velit nec nisi vulputate nonummy. Maecenas tincidunt lacus at velit. Vivamus vel nulla eget eros elementum pellentesque. Quisque porta volutpat erat. Quisque erat eros, viverra eget, congue eget, semper rutrum, nulla. Nunc purus.\n\nPhasellus in felis. Donec semper sapien a libero. Nam dui. Proin leo odio, porttitor id, consequat in, consequat ut, nulla. Sed accumsan felis. Ut at dolor quis odio consequat varius. Integer ac leo. Pellentesque ultrices mattis odio. Donec vitae nisi.\n\nNam ultrices, non erat fermentum enim, euismod est. Donec ullamcorper nulla non metus auctor fringilla. Vestibulum ante ipsum primis in faucibus orci luctus et ultrices posuere cubilia Curae; Nulla dapibus dolor vel est. Donec odio justo, sollicitudin ut, suscipit a, feugiat et, eros. Vestibulum ac est lacinia nisi venenatis tristique. Fusce congue, diam id ornare imperdiet, sapien urna pretium nisl, ut volutpat sapien arcu sed augue. Aliquam erat volutpat. In congue. Etiam justo. Etiam pretium iaculis justo. In hac habitasse platea dictumst. Etiam faucibus cursus urna. Ut tellus.\n\nNulla ut erat id mauris vulputate elementum. Nullam varius. Nulla facilisi. Cras non velit nec nisi vulputate nonummy. Maecenas tincidunt lacus at velit. Vivamus vel nulla eget eros elementum pellentesque. Quisque porta volutpat erat. Quisque erat eros, viverra eget, congue eget, semper rutrum, nulla. Nunc purus.\n\nPhasellus in felis. Donec semper sapien a libero. Nam dui. Proin leo odio, porttitor id, consequat in, consequat ut, nulla. Sed accumsan felis. Ut at dolor quis odio consequat varius. Integer ac leo. Pellentesque ultrices mattis odio. Donec vitae nisi.\n\nNam ultrices, non erat fermentum enim, euismod est. Donec ullamcorper nulla non metus auctor fringilla. Vestibulum ante ipsum primis in faucibus orci luctus et ultrices posuere cubilia Curae; Nulla dapibus dolor vel est. Donec odio justo, sollicitudin ut, suscipit a, feugiat et, eros. Vestibulum ac est lacinia nisi venenatis tristique. Fusce congue, diam id ornare imperdiet, sapien urna pretium nisl, ut volutpat sapien arcu sed augue. Aliquam erat volutpat. In congue. Etiam justo. Etiam pretium iaculis justo. In hac habitasse platea dictumst. Etiam faucibus cursus urna. Ut tellus.",
                    description: "This is a test article created for testing purposes. It contains Lorem Ipsum text to verify the functionality of the article submission and display system.",
                    category: "general"
                };
                
                try {
                    const response = await fetch('/api/submissions/submit', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(testArticle)
                    });
                    
                    if (response.ok) {
                        alert('Test article created successfully! It will appear in the submission queue and can be approved.');
                        fetchAndDisplaySubmissions();
                    } else {
                        const errorText = await response.text();
                        alert('Failed to create test article: ' + errorText);
                    }
                } catch (error) {
                    console.error('Error creating test article:', error);
                    alert('Failed to create test article. Please check the console for details.');
                }
            });
        });

        // Add event listener to hide preview when clicking outside
        document.addEventListener('click', (event) => {
            const previewPane = document.getElementById('previewPane');
            const previewButton = event.target.closest('button');
            if (previewPane.style.display === 'block' && !previewButton?.closest('#previewPane')) {
                hidePreview();
            }
        });
    </script>
</body>
</html>

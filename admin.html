<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Page</title>
</head>
<body>
    <h1>Admin Console</h1>

    <hr style="margin: 2em 0;">

    <h2>Submission Queue</h2>
    <div id="submissionQueue">
        <p>Loading submissions...</p>
    </div>

    <hr style="margin: 2em 0;">

    <h2>Existing Articles</h2>
    <div id="articlesList">
        <p>Loading existing articles...</p>
    </div>

    <div id="previewPane" style="display:none; position: fixed; top: 10%; left: 20%; width: 60%; height: 70%; background: #333; color: #fff; border: 1px solid #ccc; padding: 20px; box-shadow: 0 0 10px rgba(0,0,0,0.5); overflow-y: auto;">
        <h3 id="previewTitle"></h3>
        <p><strong>By:</strong> <span id="previewAuthor"></span></p>
        <hr>
        <div id="previewDescription" class="mb-4 text-gray-200"></div>
        <hr>
        <div id="previewContent"></div>
        <button onclick="closePreview()" style="margin-top: 20px;">Close</button>
    </div>

    <script>
        let submissionsData = [];

        const fetchAndDisplaySubmissions = async () => {
            try {
                const response = await fetch('/api/submissions');
                if (!response.ok) {
                    const queueDiv = document.getElementById('submissionQueue');
                    const errorText = await response.text();
                    queueDiv.innerHTML = `<p style="color: red;">Error loading submissions: ${errorText}</p>`;
                    return;
                }
                submissionsData = await response.json();
                const queueDiv = document.getElementById('submissionQueue');

                if (submissionsData.length === 0) {
                    queueDiv.innerHTML = '<p>No submissions yet.</p>';
                    return;
                }

                const table = `
                    <table border="1" style="width:100%; border-collapse: collapse;">
                        <thead>
                            <tr>
                                <th style="padding: 8px; text-align: left;">ID</th>
                                <th style="padding: 8px; text-align: left;">Title</th>
                                <th style="padding: 8px; text-align: left;">Author</th>
                                <th style="padding: 8px; text-align: left;">Status</th>
                                <th style="padding: 8px; text-align: left;">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${submissionsData.map(s => `
                                <tr>
                                    <td style="padding: 8px;">${s.id}</td>
                                    <td style="padding: 8px;">${s.title}</td>
                                    <td style="padding: 8px;">${s.xUsername}</td>
                                    <td style="padding: 8px;">${s.approved ? 'Approved' : 'Pending'}</td>
                                    <td style="padding: 8px;">
                                        <button onclick="previewSubmission(${s.id})">Preview</button>
                                        ${!s.approved ? `<button onclick="approveSubmission(${s.id})">Approve</button>` : ''}
                                        <button onclick="deleteSubmission(${s.id})">Delete</button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
                queueDiv.innerHTML = table;
            } catch (error) {
                console.error('Failed to fetch submissions:', error);
                document.getElementById('submissionQueue').innerHTML = '<p style="color: red;">Failed to load submissions. Check the console for details.</p>';
            }
        };

        const previewSubmission = (id) => {
            const submission = submissionsData.find(s => s.id == id);
            if (!submission) return;

            document.getElementById('previewTitle').innerText = submission.title;
            document.getElementById('previewAuthor').innerText = submission.xUsername;
            document.getElementById('previewDescription').innerText = submission.description || '';
            document.getElementById('previewContent').innerText = submission.content;
            document.getElementById('previewPane').style.display = 'block';
        };

        const closePreview = () => {
            document.getElementById('previewPane').style.display = 'none';
        };

        const approveSubmission = async (id) => {
            const response = await fetch(`/api/submissions/approve/${id}`, { method: 'PUT' });
            const result = await response.text();
            alert(result);
            fetchAndDisplaySubmissions();
        };

        const deleteSubmission = async (id) => {
            if (confirm('Are you sure you want to delete this submission?')) {
                const response = await fetch(`/api/submissions/delete/${id}`, { method: 'DELETE' });
                const result = await response.text();
                alert(result);
                fetchAndDisplaySubmissions();
            }
        };
        const fetchAndDisplayArticles = async () => {
            try {
                const response = await fetch('/api/articles');
                if (!response.ok) {
                    const articlesDiv = document.getElementById('articlesList');
                    const errorText = await response.text();
                    articlesDiv.innerHTML = `<p style="color: red;">Error loading articles: ${errorText}</p>`;
                    return;
                }
                const articles = await response.json();
                const articlesDiv = document.getElementById('articlesList');

                if (articles.length === 0) {
                    articlesDiv.innerHTML = '<p>No existing articles yet.</p>';
                    return;
                }

                const table = `
                    <table border="1" style="width:100%; border-collapse: collapse;">
                        <thead>
                            <tr>
                                <th style="padding: 8px; text-align: left;">Title</th>
                                <th style="padding: 8px; text-align: left;">URL</th>
                                <th style="padding: 8px; text-align: left;">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${articles.map(article => `
                                <tr>
                                    <td style="padding: 8px;">${article.title}</td>
                                    <td style="padding: 8px;"><a href="${article.url}" target="_blank">${article.url}</a></td>
                                    <td style="padding: 8px;">
                                        <button onclick="deleteArticle('${article.slug}')">Delete</button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
                articlesDiv.innerHTML = table;
            } catch (error) {
                console.error('Failed to fetch articles:', error);
                document.getElementById('articlesList').innerHTML = '<p style="color: red;">Failed to load articles. Check the console for details.</p>';
            }
        };

        const deleteArticle = async (slug) => {
            if (confirm(`Are you sure you want to delete the article "${slug}"? This action cannot be undone.`)) {
                try {
                    const response = await fetch(`/api/articles/${slug}`, {
                        method: 'DELETE'
                    });
                    const result = await response.text();
                    alert(result);
                    fetchAndDisplayArticles();
                } catch (error) {
                    console.error('Failed to delete article:', error);
                    alert('Failed to delete article. Please try again.');
                }
            }
        };

        document.addEventListener('DOMContentLoaded', () => {
            fetchAndDisplaySubmissions();
            fetchAndDisplayArticles();
        });
    </script>
</body>
</html>

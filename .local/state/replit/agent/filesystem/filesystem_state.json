{"file_contents":{"admin.js":{"content":"\nconst express = require('express');\nconst router = express.Router();\n\n// For now, all admin routes are open\n\n// Admin dashboard (open to everyone)\nrouter.get('/dashboard', (req, res) => {\n    res.send('Welcome to the admin dashboard');\n});\n\nmodule.exports = { router };\n","size_bytes":271},"README.md":{"content":"# ETC Hub - Simplified Version\n\nThis is a simplified version of the ETC Hub with the following changes:\n\n## Key Changes Made\n\n1. **Removed Authentication**: All authentication logic has been removed\n   - No IP whitelisting required\n   - Anyone can access the admin panel\n   - Anyone can submit articles\n   - Anyone can approve/delet articles\n\n2. **Article Submission Workflow**\n   - Users can submit articles via the submit form\n   - Articles are stored in a temporary submissions queue\n   - Admin can approve articles to make them publicly available\n   - Approved articles are saved as HTML files in the `generated_news` directory\n   - Approved articles are accessible via `/news/{article-name}.html`\n\n3. **Admin Panel**\n   - Fully open access - anyone can view the admin panel\n   - Can view all submissions\n   - Can approve or delete any submission\n   - Approving creates a static HTML file in the news directory\n\n## Technical Implementation\n\n### Files Modified:\n- `server.js`: Removed IP whitelist middleware and authentication checks\n- `submissions.js`: Removed IP whitelist middleware from all endpoints\n- `admin.js`: Removed IP whitelist middleware and authentication logic\n- `news.html`: Updated to properly display generated news articles\n- `submit.html`: Fixed form submission to match backend expectations\n\n### Directory Structure:\n- `generated_news/` - Stores approved articles as static HTML files\n\n## How to Run\n\n1. Install dependencies:\n```bash\nnpm install\n```\n\n2. Start the server:\n```bash\nnpm start\n```\n\n3. Visit:\n   - Main site: http://localhost:5000\n   - Admin panel: http://localhost:5000/admin\n   - Submit form: http://localhost:5000/submit.html\n   - News articles: http://localhost:5000/news","size_bytes":1712},"submissions.js":{"content":"\nconst express = require('express');\nconst router = express.Router();\nconst fs = require('fs');\nconst path = require('path');\nconst storage = require('./storage');\n\n// Ensure generated_news directory exists (for local storage)\nconst generatedNewsDir = path.join(__dirname, 'generated_news');\nif (storage.STORAGE_MODE === 'local' && !fs.existsSync(generatedNewsDir)) {\n    fs.mkdirSync(generatedNewsDir, { recursive: true });\n}\n\n// Load submissions based on storage mode\nlet submissions = [];\nconst loadSubmissions = async () => {\n    submissions = await storage.loadSubmissions();\n};\n\nloadSubmissions();\n\n// Helper function to create a URL-friendly slug\nconst slugify = (text) => {\n    return text.toString().toLowerCase()\n        .replace(/\\s+/g, '-')\n        .replace(/[^\\w\\-]+/g, '')\n        .replace(/\\-\\-+/g, '-')\n        .replace(/^-+/, '')\n        .replace(/-+$/, '');\n};\n\n// Endpoint for submitting articles\nrouter.post('/submit', async (req, res) => {\n    const { title, xUsername, content, description, category } = req.body;\n    if (!title || !xUsername || !content) {\n        return res.status(400).send('Missing required fields');\n    }\n    \n    const newSubmission = {\n        id: submissions.length + 1,\n        title,\n        xUsername,\n        content,\n        description: description || '',\n        category: 'news',\n        approved: false\n    };\n    \n    try {\n        if (storage.STORAGE_MODE === 'database') {\n            const id = await storage.saveSubmission(newSubmission);\n            newSubmission.id = id;\n        } else {\n            await storage.saveSubmission(newSubmission);\n        }\n        submissions.push(newSubmission);\n        res.status(201).send('Submission successful');\n    } catch (error) {\n        console.error('Error saving submission:', error);\n        res.status(500).send('Error saving submission');\n    }\n});\n\n// Endpoint to get all submissions\nrouter.get('/', async (req, res) => {\n    try {\n        const currentSubmissions = await storage.loadSubmissions();\n        res.json(currentSubmissions);\n    } catch (error) {\n        console.error('Error loading submissions:', error);\n        res.status(500).json({ error: 'Error loading submissions' });\n    }\n});\n\n// Endpoint for approving articles\nrouter.put('/approve/:id', async (req, res) => {\n    const { id } = req.params;\n    \n    try {\n        const allSubmissions = await storage.loadSubmissions();\n        const submission = allSubmissions.find(s => s.id == id);\n        \n        if (!submission) {\n            return res.status(404).send('Submission not found');\n        }\n\n        const templatePath = path.join(__dirname, 'templatestory.html');\n        const data = fs.readFileSync(templatePath, 'utf8');\n\n        const slug = slugify(submission.title);\n        \n        // Process content into paragraphs\n        const paragraphs = submission.content\n            .split(/\\n\\s*\\n/)\n            .map(paragraph => {\n                const lines = paragraph.split('\\n');\n                const processedLines = lines.map(line => line.trim()).filter(line => line.length > 0);\n                const paragraphContent = processedLines.join('<br>');\n                return paragraphContent.length > 0 ? `<p>${paragraphContent}</p>` : '';\n            })\n            .filter(p => p.length > 0);\n        \n        const contentWithParagraphs = paragraphs.join('\\n');\n        \n        const newContent = data\n            .replace(/{{TITLE}}/g, submission.title)\n            .replace(/{{AUTHOR}}/g, submission.xUsername)\n            .replace(/{{CONTENT}}/g, contentWithParagraphs)\n            .replace(/{{DESCRIPTION}}/g, submission.description || '')\n            .replace(/{{CATEGORY}}/g, 'news');\n\n        // Save article\n        await storage.saveArticle(slug, submission.title, submission.xUsername, submission.description || '', newContent, 'news');\n\n        // Update submission status and remove from submissions\n        await storage.deleteSubmission(id);\n        \n        // Reload submissions\n        submissions = await storage.loadSubmissions();\n        \n        res.send(`Submission approved and article generated at /news/${slug}`);\n    } catch (error) {\n        console.error('Error approving submission:', error);\n        res.status(500).send('Error approving submission');\n    }\n});\n\n// Endpoint for deleting submissions\nrouter.delete('/delete/:id', async (req, res) => {\n    const { id } = req.params;\n    \n    try {\n        await storage.deleteSubmission(id);\n        submissions = await storage.loadSubmissions();\n        res.send('Submission deleted');\n    } catch (error) {\n        console.error('Error deleting submission:', error);\n        res.status(500).send('Error deleting submission');\n    }\n});\n\nmodule.exports = router;\n","size_bytes":4750},"storage.js":{"content":"const fs = require('fs');\nconst path = require('path');\nconst { Pool } = require('pg');\n\n// Read storage mode from config file (1 = local files, 2 = database)\nconst getStorageMode = () => {\n    try {\n        const configPath = path.join(__dirname, 'storage-config.txt');\n        const mode = fs.readFileSync(configPath, 'utf8').trim();\n        return parseInt(mode) === 2 ? 'database' : 'local';\n    } catch (error) {\n        console.warn('storage-config.txt not found, defaulting to local storage');\n        return 'local';\n    }\n};\n\nconst STORAGE_MODE = getStorageMode();\nconst DB_POOL = STORAGE_MODE === 'database' ? new Pool({\n    connectionString: process.env.DATABASE_URL\n}) : null;\n\n// Initialize database schema if using database storage\nconst initDatabase = async () => {\n    if (STORAGE_MODE !== 'database' || !DB_POOL) return;\n    \n    try {\n        await DB_POOL.query(`\n            CREATE TABLE IF NOT EXISTS submissions (\n                id SERIAL PRIMARY KEY,\n                title VARCHAR(255) NOT NULL,\n                x_username VARCHAR(255) NOT NULL,\n                content TEXT NOT NULL,\n                description TEXT,\n                category VARCHAR(50) DEFAULT 'news',\n                approved BOOLEAN DEFAULT FALSE,\n                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP\n            );\n            \n            CREATE TABLE IF NOT EXISTS articles (\n                id SERIAL PRIMARY KEY,\n                slug VARCHAR(255) UNIQUE NOT NULL,\n                title VARCHAR(255) NOT NULL,\n                author VARCHAR(255),\n                description TEXT,\n                content TEXT NOT NULL,\n                category VARCHAR(50) DEFAULT 'news',\n                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP\n            );\n        `);\n        console.log('Database initialized successfully');\n    } catch (error) {\n        console.error('Error initializing database:', error);\n    }\n};\n\n// Local file storage functions\nconst loadSubmissionsLocal = () => {\n    const submissionsFilePath = path.join(__dirname, 'submissions.json');\n    let submissions = [];\n    if (fs.existsSync(submissionsFilePath)) {\n        try {\n            const data = fs.readFileSync(submissionsFilePath, 'utf8');\n            submissions = JSON.parse(data);\n        } catch (error) {\n            console.error('Error reading submissions file:', error);\n        }\n    }\n    return submissions;\n};\n\nconst saveSubmissionsLocal = (submissions) => {\n    try {\n        const submissionsFilePath = path.join(__dirname, 'submissions.json');\n        fs.writeFileSync(submissionsFilePath, JSON.stringify(submissions, null, 2));\n    } catch (error) {\n        console.error('Error writing to submissions file:', error);\n    }\n};\n\n// Database storage functions\nconst loadSubmissionsDatabase = async () => {\n    try {\n        const result = await DB_POOL.query('SELECT id, title, x_username as \"xUsername\", content, description, category, approved FROM submissions ORDER BY id DESC');\n        return result.rows;\n    } catch (error) {\n        console.error('Error loading submissions from database:', error);\n        return [];\n    }\n};\n\nconst saveSubmissionDatabase = async (submission) => {\n    try {\n        const result = await DB_POOL.query(\n            'INSERT INTO submissions (title, x_username, content, description, category, approved) VALUES ($1, $2, $3, $4, $5, $6) RETURNING id',\n            [submission.title, submission.xUsername, submission.content, submission.description, submission.category, submission.approved]\n        );\n        return result.rows[0].id;\n    } catch (error) {\n        console.error('Error saving submission to database:', error);\n        throw error;\n    }\n};\n\nconst deleteSubmissionDatabase = async (id) => {\n    try {\n        await DB_POOL.query('DELETE FROM submissions WHERE id = $1', [id]);\n    } catch (error) {\n        console.error('Error deleting submission from database:', error);\n        throw error;\n    }\n};\n\nconst updateSubmissionDatabase = async (id, approved) => {\n    try {\n        const result = await DB_POOL.query(\n            'UPDATE submissions SET approved = $1 WHERE id = $2 RETURNING *',\n            [approved, id]\n        );\n        return result.rows[0];\n    } catch (error) {\n        console.error('Error updating submission in database:', error);\n        throw error;\n    }\n};\n\n// Article storage functions for database\nconst saveArticleDatabase = async (slug, title, author, description, content, category) => {\n    try {\n        await DB_POOL.query(\n            'INSERT INTO articles (slug, title, author, description, content, category) VALUES ($1, $2, $3, $4, $5, $6) ON CONFLICT (slug) DO UPDATE SET content = $5, title = $2, author = $3',\n            [slug, title, author, description, content, category]\n        );\n    } catch (error) {\n        console.error('Error saving article to database:', error);\n        throw error;\n    }\n};\n\nconst getArticleDatabase = async (slug) => {\n    try {\n        const result = await DB_POOL.query('SELECT * FROM articles WHERE slug = $1', [slug]);\n        return result.rows[0] || null;\n    } catch (error) {\n        console.error('Error retrieving article from database:', error);\n        return null;\n    }\n};\n\nconst getAllArticlesDatabase = async () => {\n    try {\n        const result = await DB_POOL.query('SELECT slug, title, author, description, category FROM articles ORDER BY created_at DESC');\n        return result.rows;\n    } catch (error) {\n        console.error('Error retrieving articles from database:', error);\n        return [];\n    }\n};\n\nconst deleteArticleDatabase = async (slug) => {\n    try {\n        await DB_POOL.query('DELETE FROM articles WHERE slug = $1', [slug]);\n    } catch (error) {\n        console.error('Error deleting article from database:', error);\n        throw error;\n    }\n};\n\nmodule.exports = {\n    STORAGE_MODE,\n    initDatabase,\n    \n    // Submissions\n    loadSubmissions: STORAGE_MODE === 'database' ? loadSubmissionsDatabase : loadSubmissionsLocal,\n    saveSubmission: STORAGE_MODE === 'database' ? saveSubmissionDatabase : (sub) => {\n        const submissions = loadSubmissionsLocal();\n        submissions.push(sub);\n        saveSubmissionsLocal(submissions);\n        return sub.id;\n    },\n    deleteSubmission: STORAGE_MODE === 'database' ? deleteSubmissionDatabase : (id) => {\n        const submissions = loadSubmissionsLocal();\n        const index = submissions.findIndex(s => s.id == id);\n        if (index !== -1) submissions.splice(index, 1);\n        saveSubmissionsLocal(submissions);\n    },\n    updateSubmission: STORAGE_MODE === 'database' ? updateSubmissionDatabase : (id, approved) => {\n        const submissions = loadSubmissionsLocal();\n        const submission = submissions.find(s => s.id == id);\n        if (submission) submission.approved = approved;\n        saveSubmissionsLocal(submissions);\n        return submission;\n    },\n    \n    // Articles\n    saveArticle: STORAGE_MODE === 'database' ? saveArticleDatabase : (slug, title, author, description, content, category) => {\n        const dir = path.join(__dirname, 'generated_news');\n        if (!fs.existsSync(dir)) fs.mkdirSync(dir, { recursive: true });\n        fs.writeFileSync(path.join(dir, `${slug}.html`), content);\n    },\n    getArticle: STORAGE_MODE === 'database' ? getArticleDatabase : (slug) => {\n        const filePath = path.join(__dirname, 'generated_news', `${slug}.html`);\n        if (fs.existsSync(filePath)) {\n            return { slug, content: fs.readFileSync(filePath, 'utf8') };\n        }\n        return null;\n    },\n    getAllArticles: STORAGE_MODE === 'database' ? getAllArticlesDatabase : () => {\n        const dir = path.join(__dirname, 'generated_news');\n        if (!fs.existsSync(dir)) return [];\n        const files = fs.readdirSync(dir).filter(f => f.endsWith('.html'));\n        return files.map(file => {\n            const slug = file.slice(0, -5);\n            const content = fs.readFileSync(path.join(dir, file), 'utf8');\n            const titleMatch = content.match(/<h1 class=\"text-4xl lg:text-5xl font-bold orbitron mb-4 copper-gradient\">(.*?)<\\/h1>/);\n            const title = titleMatch ? titleMatch[1] : slug.replace(/-/g, ' ');\n            const authorMatch = content.match(/<div class=\"text-gray-400 text-sm\">\\s*<span>By\\s*(.*?)<\\/span>\\s*<\\/div>/);\n            const author = authorMatch ? authorMatch[1] : 'Admin User';\n            const descriptionMatch = content.match(/<div class=\"mb-8\">\\s*<p class=\"text-gray-300 text-lg\">(.*?)<\\/p>\\s*<\\/div>/);\n            const description = descriptionMatch ? descriptionMatch[1] : '';\n            return { slug, title, author, description, category: 'news', url: `/news/${slug}` };\n        });\n    },\n    deleteArticle: STORAGE_MODE === 'database' ? deleteArticleDatabase : (slug) => {\n        fs.unlinkSync(path.join(__dirname, 'generated_news', `${slug}.html`));\n    }\n};\n","size_bytes":8888},"server.js":{"content":"\nconst express = require('express');\nconst path = require('path');\nconst fs = require('fs');\nconst submissionsRouter = require('./submissions');\nconst storage = require('./storage');\nconst { router: adminRouter } = require('./admin');\n\nconst app = express();\nconst PORT = process.env.PORT || 5000;\n\napp.use(express.json());\napp.use(express.static(__dirname));\n\n// Initialize database if using database storage\nstorage.initDatabase().catch(err => console.error('Database initialization failed:', err));\n\n// Serve static files from generated_news directory\napp.use('/news', express.static(path.join(__dirname, 'generated_news')));\n\n// Handle article pages without .html extension\napp.get('/news/:slug', async (req, res) => {\n    const slug = req.params.slug;\n    \n    if (storage.STORAGE_MODE === 'database') {\n        try {\n            const article = await storage.getArticle(slug);\n            if (article) {\n                res.send(article.content);\n            } else {\n                res.status(404).send('Article not found');\n            }\n        } catch (error) {\n            res.status(500).send('Error retrieving article');\n        }\n    } else {\n        const filePath = path.join(__dirname, 'generated_news', `${slug}.html`);\n        fs.access(filePath, fs.constants.F_OK, (err) => {\n            if (err) {\n                res.status(404).send('Article not found');\n            } else {\n                res.sendFile(filePath);\n            }\n        });\n    }\n});\n\napp.use('/api/submissions', submissionsRouter);\napp.use('/api/admin', adminRouter);\n\napp.get('/admin', (req, res) => {\n    res.sendFile(path.join(__dirname, 'admin.html'));\n});\n\napp.get('/', (req, res) => {\n    res.sendFile(path.join(__dirname, 'index.html'));\n});\n\napp.get('/news', (req, res) =>\n    res.sendFile(path.join(__dirname, 'news.html'))\n);\n\napp.get('/submit', (req, res) =>\n    res.sendFile(path.join(__dirname, 'submit.html'))\n);\n\napp.get('/templatestory', (req, res) =>\n    res.sendFile(path.join(__dirname, 'templatestory.html'))\n);\n\n// API endpoint to list all articles\napp.get('/api/articles', async (req, res) => {\n    try {\n        const articles = await storage.getAllArticles();\n        const articlesWithUrls = articles.map(article => ({\n            ...article,\n            url: `/news/${article.slug}`\n        }));\n        res.json(articlesWithUrls);\n    } catch (error) {\n        console.error('Error reading articles:', error);\n        res.status(500).json({ error: 'Failed to read articles' });\n    }\n});\n\n// API endpoint to delete an article\napp.delete('/api/articles/:slug', async (req, res) => {\n    const slug = req.params.slug;\n    \n    try {\n        await storage.deleteArticle(slug);\n        res.send(`Article \"${slug}\" deleted successfully`);\n    } catch (error) {\n        console.error('Error deleting article:', error);\n        res.status(500).send('Error deleting article');\n    }\n});\n\napp.listen(PORT, '0.0.0.0', () => {\n    console.log(`Server running on http://0.0.0.0:${PORT}`);\n    console.log(`Storage mode: ${storage.STORAGE_MODE}`);\n});\n","size_bytes":3059},"test-implementation.js":{"content":"const fs = require('fs');\nconst path = require('path');\n\nconsole.log(\"Testing implementation of changes...\");\n\n// Check that server.js no longer imports ipWhitelist\nconst serverContent = fs.readFileSync('./server.js', 'utf8');\nif (serverContent.includes('ipWhitelist')) {\n    console.log(\"‚ùå FAIL: server.js still contains ipWhitelist references\");\n    process.exit(1);\n} else {\n    console.log(\"‚úÖ PASS: server.js no longer contains ipWhitelist references\");\n}\n\n// Check that submissions.js no longer imports ipWhitelist\nconst submissionsContent = fs.readFileSync('./submissions.js', 'utf8');\nif (submissionsContent.includes('ipWhitelist')) {\n    console.log(\"‚ùå FAIL: submissions.js still contains ipWhitelist references\");\n    process.exit(1);\n} else {\n    console.log(\"‚úÖ PASS: submissions.js no longer contains ipWhitelist references\");\n}\n\n// Check that admin.js no longer has IP whitelisting logic\nconst adminContent = fs.readFileSync('./admin.js', 'utf8');\nif (adminContent.includes('ipWhitelist')) {\n    console.log(\"‚ùå FAIL: admin.js still contains ipWhitelist references\");\n    process.exit(1);\n} else {\n    console.log(\"‚úÖ PASS: admin.js no longer contains ipWhitelist references\");\n}\n\n// Verify generated_news directory is created\nconst generatedNewsDir = path.join(__dirname, 'generated_news');\nif (fs.existsSync(generatedNewsDir)) {\n    console.log(\"‚úÖ PASS: generated_news directory exists\");\n} else {\n    console.log(\"‚ö†Ô∏è  INFO: generated_news directory doesn't exist yet (will be created on first article)\");\n}\n\n// Check that news.html has the correct navigation \nconst newsContent = fs.readFileSync('./news.html', 'utf8');\nif (newsContent.includes('href=\"news.html\" class=\"nav-link text-gray-300 hover:text-white px-3 py-2 text-sm font-medium\">News</a>')) {\n    console.log(\"‚úÖ PASS: news.html has correct navigation\");\n} else {\n    console.log(\"‚ùå FAIL: news.html navigation not updated properly\");\n    process.exit(1);\n}\n\n// Check that submit.html sends correct field names\nconst submitContent = fs.readFileSync('./submit.html', 'utf8');\nif (submitContent.includes('xUsername: author')) {\n    console.log(\"‚úÖ PASS: submit.html sends correct field name (xUsername)\");\n} else {\n    console.log(\"‚ùå FAIL: submit.html doesn't send correct field name\");\n    process.exit(1);\n}\n\nconsole.log(\"\\nüéâ All tests passed! Implementation looks good.\");","size_bytes":2374}},"version":2}